## gRPC Basic Auth

Необходимо написать веб сервис который занимается хранением профилей пользователей и их авторизацией.

Профиль имеет набор полей:
1. id (uuid, unique)
2. email
3. username (unique)
4. password
5. admin (bool)

Сервис должeн иметь набор ручек (gRPC):
Создание пользователя,
Выдача списка пользователей
Выдача юзера по id
Изменение и удаление профиля

Сервис использует basic access authentication (https://en.wikipedia.org/wiki/Basic_access_authentication)

Просматривать профили могут все зарегистрированные пользователи.
Админ может создавать, изменять и удалять профили.

Для хранения данных профилей необходимо реализовать примитивную in memory базу данных, не используя сторонние решения.

## Зависимости для разработки

* [golangci-lint](https://golangci-lint.run/) -- Для поддержки кода в хорошем состоянии
* [protoc](https://github.com/protocolbuffers/protobuf/releases/tag/v24.4) + [proto-gen-go](google.golang.org/protobuf/cmd/protoc-gen-go@v1.28) & [protoc-gen-go-grpc](google.golang.org/grpc/cmd/protoc-gen-go-grpc@v1.2) -- Для компиляции proto файлов
* [pre-commit](https://pre-commit.com/) -- Для исключения возможности коммитить "грязный" код
* [docker](https://docs.docker.com/get-started/)(with compose) -- Для разворачивания окружения
* [make](https://www.gnu.org/software/make/) -- Для упрощения работы с окружением

## Запуск

Перед запуском проекта нужно прописать необходимые переменные окружения.
Docker compose использует `.env` файл, пример которого находится в `.env.example`.

После создания `.env` файла, можно запустить проект с помощью команды `make run`,
что запустит проект через docker compose.

## Тестирование

В проекте реализованы unit тесты для `MemoryRepository` и
сквозные end-to-end тесты для всего приложения.

### Unit тесты

Запуск unit тестов осуществляется командой `make test-unit`.

### End-to-end тесты

Для end-to-end тестов приложение запускается в изолированном docker контейнере,
с использованием [testcontainers](https://testcontainers.com/).
Сами же тесты вызываются из хостовой системы.

__end-to-end тесты не читают .env файл, поэтому необходимо прописать переменные окружения вручную.__

Запуск end-to-end тестов осуществляется командой `make test-e2e`.

## Архитектура приложения

Директория `proto` содержит описание gRPC сервиса и сгенерированный код.

Директория `internal` содержит основной код приложения.

В директории `tests` содержатся end-to-end тесты.

В приложении используется чистая архитектура, с разделением на слои:
* transport
* usecases
* infrastructure

## Решения и примечания

* Для обработки доменных ошибок в пакете internal/common был реализован
простой механизм обработки ошибок, описанный Nate Finch здесь [Error Flags](https://npf.io/2021/04/errorflags/)

* Так как проект является примитивным CRUD интерфейсом и не содержит
сложной бизнес-логики, было принято решение отказаться от слоя бизнес-логики
и использовать обычную анемичную модель для представления данных в приложении.

* API приложения следует CQS принципу, поэтому команды апи,
такие, как создание и изменение пользователя, возвращают пустой объект.

* Для хранения данных был выбран sync.Map, так как он является потокобезопасным

* Так как sync.Map не предоставляет возможности получить количество записей,
MemoryRepository.GetAll создаёт пустой срез и на каждой
итерации расширяет его при необходимости (append).
Это негативно сказывается на производительности.
Можно было бы считать количество записей в отдельной переменной,
но на данном этапе в этом нет необходимости.

* Так как для создания пользователя необходимо авторизоваться,
как администратор, было принято решение создавать первого администратора
при старте приложения, используя значения из переменных окружения.

* Для хранения паролей пользователей используется bcrypt.
